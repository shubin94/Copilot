# Deployment Guide: Vercel + Render + Supabase

This guide covers deploying the AskDetectives platform with:
- **Frontend**: Vercel
- **Backend**: Render
- **Database**: Supabase

## Prerequisites

- GitHub account with your code repository
- Vercel account (free tier works)
- Render account (free tier works)
- Supabase account with database already set up

## Backend Deployment (Render)

### 1. Push Code to GitHub

```bash
git add .
git commit -m "Prepare for Render deployment"
git push origin main
```

### 2. Deploy on Render

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New +" → "Web Service"
3. Connect your GitHub repository
4. Render will auto-detect the `render.yaml` file
5. Click "Create Web Service"

### 3. Add Secret Environment Variables

In Render Dashboard → Your Service → Environment:

Add these secrets (marked as `sync: false` in render.yaml):

```bash
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
SENDPULSE_API_ID=your-sendpulse-api-id
SENDPULSE_API_SECRET=your-sendpulse-api-secret
```

### 4. Note Your Backend URL

After deployment completes, copy your backend URL:
```
https://askdetectives-backend.onrender.com
```

## Frontend Deployment (Vercel)

### 1. Deploy on Vercel

**Option A: Via Dashboard**

1. Go to [Vercel Dashboard](https://vercel.com/new)
2. Import your GitHub repository
3. Configure:
   - **Framework Preset**: Vite
   - **Root Directory**: `./`
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist/public`

4. Add Environment Variable:
   - `VITE_API_URL` = `https://askdetectives-backend.onrender.com`

5. Click "Deploy"

**Option B: Via CLI**

```bash
npm install -g vercel
vercel --prod
```

### 2. Update Backend with Frontend URL

After Vercel deployment:

1. Copy your Vercel URL (e.g., `https://askdetectives.vercel.app`)
2. Go to Render Dashboard → Your Service → Environment
3. Update:
   - `FRONTEND_URL` = `https://askdetectives.vercel.app`
   - `CSRF_ALLOWED_ORIGINS` = `https://askdetectives.vercel.app`
4. Save and Redeploy

### 3. Update vercel.json

Update the API proxy destination in `vercel.json`:

```json
{
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://askdetectives-backend.onrender.com/api/:path*"
    }
  ]
}
```

## Database Setup (Supabase)

Your database is already configured. Verify these settings:

### Connection String
```
postgresql://postgres.gjgrwxxtkyggwfrydpdb:AKshubin123@aws-1-ap-south-1.pooler.supabase.com:6543/postgres
```

### SSL Configuration
✅ SSL is configured with `rejectUnauthorized: false` to accept Supabase's self-signed certificates

## Post-Deployment Checklist

### Test Backend

```bash
curl https://askdetectives-backend.onrender.com/api/health
```

Expected response: `{"status":"ok"}` or similar

### Test Frontend

1. Visit your Vercel URL
2. Open DevTools → Network tab
3. Verify API calls go to your Render backend
4. Check that cookies are being set

### Test Authentication

1. Try to log in
2. Verify session persistence
3. Check protected routes

## Environment Variables Summary

### Backend (Render)

Required:
- `NODE_ENV=production`
- `DATABASE_URL` - Supabase connection string
- `PORT=10000` (Render default)
- `HOST=0.0.0.0`
- `SESSION_SECRET` - Auto-generated by Render
- `FRONTEND_URL` - Your Vercel URL
- `CSRF_ALLOWED_ORIGINS` - Your Vercel URL

Secrets (set manually):
- `SUPABASE_SERVICE_ROLE_KEY`
- `SENDPULSE_API_ID`
- `SENDPULSE_API_SECRET`

### Frontend (Vercel)

Required:
- `VITE_API_URL` - Your Render backend URL

## Troubleshooting

### CORS Errors

**Symptom**: API calls fail with CORS errors

**Fix**:
1. Verify `FRONTEND_URL` in Render matches your Vercel URL exactly
2. Check that backend CORS is configured correctly
3. Ensure cookies have `sameSite: 'none'` in production

### Session Not Persisting

**Symptom**: User gets logged out on page refresh

**Fix**:
1. Verify `sameSite: 'none'` and `secure: true` in production
2. Check that `credentials: true` is set in frontend API calls
3. Ensure HTTPS is used (both Vercel and Render provide HTTPS)

### API 404 Errors

**Symptom**: API routes return 404

**Fix**:
1. Check `VITE_API_URL` is set in Vercel
2. Verify API proxy in `vercel.json`
3. Check Render service is running

### Render Cold Starts

**Symptom**: First request takes 15-30 seconds

**Solution**: This is normal for Render free tier. Upgrade to paid plan or implement a ping service.

## Files Modified for Deployment

1. `render.yaml` - Render service configuration
2. `vercel.json` - Vercel build and proxy configuration
3. `.env.production` - Production environment variables
4. `client/src/lib/api.ts` - API base URL configuration
5. `server/app.ts` - CORS and session configuration
6. `db/index.ts` - SSL configuration for Supabase

## Support

For issues:
1. Check Render logs: Dashboard → Your Service → Logs
2. Check Vercel logs: Dashboard → Your Project → Deployments → View Logs
3. Check browser console for frontend errors
